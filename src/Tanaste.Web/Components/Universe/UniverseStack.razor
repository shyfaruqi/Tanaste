@namespace Tanaste.Web.Components.Universe
@inject AutomotiveModeService AutomotiveMode
@implements IDisposable

@* "Your Universes" Bento grid — Spatial Bento design.
   All tiles are 1×1 (hero is handled separately by HubHero).
   Each tile shows: title, work count, and media-type icons row. *@

@if (VisibleHubs is { Count: > 0 })
{
    <MudText Typo="Typo.h5" Class="mb-4" Style="font-weight: 600;">
        Your Universes
    </MudText>

    <BentoGrid Class="@Class">
        @foreach (var hub in VisibleHubs)
        {
            var extraClass = AutomotiveMode.IsActive ? "automotive-tile" : string.Empty;

            <BentoItem ColSpan="1" RowSpan="1"
                       GlowColor="@hub.DominantHexColor"
                       Class="@extraClass">

                <div class="bento-hub-content" @onclick="() => OnHubSelected.InvokeAsync(hub)">

                    @* ── Title ── *@
                    <MudText Typo="Typo.h5" Class="mb-1" Style="font-weight: 600;">
                        @hub.DisplayName
                    </MudText>

                    @* ── Work count ── *@
                    <MudText Typo="Typo.body2" Style="color: rgba(255,255,255,0.50);">
                        @hub.WorkCount @(hub.WorkCount == 1 ? "work" : "works")
                    </MudText>

                    @* ── Media type icons row — pushed to bottom ── *@
                    <MudStack Row="true" Spacing="2" Class="mt-auto pt-3"
                              AlignItems="AlignItems.Center">
                        @foreach (var icon in GetDistinctMediaIcons(hub))
                        {
                            <MudIcon Icon="@icon" Size="Size.Small"
                                     Style="color: rgba(255,255,255,0.35); font-size: 22px;" />
                        }
                    </MudStack>

                </div>
            </BentoItem>
        }
    </BentoGrid>
}
else if (VisibleHubs is { Count: 0 } && Hubs is { Count: > 0 })
{
    @* Filter active (e.g. Automotive Mode) but no matching hubs *@
    <MudPaper Class="pa-8 d-flex flex-column align-center" Elevation="0"
              Style="background: rgba(255,255,255,0.03); border-radius: 32px; border: 1px solid rgba(255,255,255,0.06);">
        <MudIcon Icon="@Icons.Material.Filled.FilterAlt"
                 Size="Size.Large" Color="Color.Secondary" Class="mb-3" />
        <MudText Typo="Typo.h6" Class="mb-2">No matching Hubs</MudText>
        <MudText Typo="Typo.body2" Style="color: rgba(255,255,255,0.50);">
            Try a different intent filter from the dock below.
        </MudText>
    </MudPaper>
}
else
{
    <MudPaper Class="pa-8 d-flex flex-column align-center" Elevation="0"
              Style="background: rgba(255,255,255,0.03); border-radius: 32px; border: 1px solid rgba(255,255,255,0.06);">
        <MudIcon Icon="@Icons.Material.Filled.LibraryAdd"
                 Size="Size.Large" Color="Color.Secondary" Class="mb-3" />
        <MudText Typo="Typo.h6" Class="mb-2">Your library is empty</MudText>
        <MudText Typo="Typo.body2" Style="color: rgba(255,255,255,0.50);">
            Configure a watch directory and drop files in to get started.
        </MudText>
    </MudPaper>
}

@code {
    [Parameter] public List<HubViewModel>?         Hubs          { get; set; }
    [Parameter] public string?                     Class         { get; set; }
    [Parameter] public EventCallback<HubViewModel> OnHubSelected { get; set; }

    /// <summary>
    /// Filtered hub list: in Automotive Mode only Audio-type hubs are shown.
    /// In normal mode every hub passes through.
    /// </summary>
    private List<HubViewModel> VisibleHubs =>
        Hubs is null
            ? []
            : AutomotiveMode.IsActive
                ? Hubs.Where(h => h.Works.Any(w => UniverseMapper.IsAudio(w.MediaType))).ToList()
                : Hubs;

    protected override void OnInitialized() =>
        AutomotiveMode.OnChanged += OnAutomotiveChanged;

    private void OnAutomotiveChanged() => InvokeAsync(StateHasChanged);

    public void Dispose() =>
        AutomotiveMode.OnChanged -= OnAutomotiveChanged;

    /// <summary>
    /// Returns distinct media-type icons for a hub (video, book, audio, comic).
    /// Each icon appears at most once regardless of how many Works share that type.
    /// </summary>
    private static List<string> GetDistinctMediaIcons(HubViewModel hub)
    {
        var icons = new List<string>();
        var types = hub.Works.Select(w => w.MediaType.ToLowerInvariant()).Distinct().ToList();

        if (types.Any(t => t.Contains("video") || t.Contains("movie")))
            icons.Add(Icons.Material.Filled.PlayCircle);
        if (types.Any(t => t.Contains("epub") || t.Contains("book")))
            icons.Add(Icons.Material.Filled.MenuBook);
        if (types.Any(t => t.Contains("audio")))
            icons.Add(Icons.Material.Filled.Headphones);
        if (types.Any(t => t.Contains("comic") || t.Contains("cbz") || t.Contains("cbr")))
            icons.Add(Icons.Material.Filled.AutoStories);

        if (icons.Count == 0)
            icons.Add(Icons.Material.Filled.Folder);

        return icons;
    }
}

<style>
    .bento-hub-content {
        height:          100%;
        min-height:      inherit;
        padding:         1.5rem 1.75rem;
        display:         flex;
        flex-direction:  column;
        cursor:          pointer;
        user-select:     none;
    }
</style>
