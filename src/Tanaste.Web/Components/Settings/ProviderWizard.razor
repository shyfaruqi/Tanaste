@namespace Tanaste.Web.Components.Settings

@* Provider Wizard — right-anchored drawer with a three-step flow for adding
   or editing a custom metadata source.

   Steps:
     1. Basic Details  — Name, Endpoint URL, API Key
     2. Advanced Mapping — placeholder for future schema mapping
     3. Verify Connection — stub connection test

   All steps are stubs in this initialisation pass. The wizard collects input
   but real registration requires Engine-side custom-provider support (Phase 2).

   Style: matches CuratorsDrawer glassmorphic pattern exactly. *@

<MudDrawer Open="@Open"
           OpenChanged="@OnOpenChangedHandler"
           Anchor="Anchor.End"
           Width="540px"
           Overlay="true"
           Variant="DrawerVariant.Temporary"
           Style="@DrawerStyle">

    @* ── Header ─────────────────────────────────────────────────────────── *@
    <MudStack Row="true" AlignItems="AlignItems.Center" Class="pa-4">
        <MudIcon Icon="@(IsEditing
                     ? Icons.Material.Outlined.Edit
                     : Icons.Material.Outlined.AddCircleOutline)"
                 Color="Color.Primary" Class="mr-2" />
        <MudText Typo="Typo.h6" Style="flex: 1;">
            @(IsEditing ? "Edit Source" : "Add Source")
        </MudText>
        <MudIconButton Icon="@Icons.Material.Filled.Close"
                       Color="Color.Default"
                       Size="Size.Small"
                       OnClick="@CloseDrawer" />
    </MudStack>

    <MudDivider Class="mb-2" />

    @* ── Editing context banner ─────────────────────────────────────────── *@
    @if (IsEditing)
    {
        <MudPaper Elevation="0" Style="@InnerCardStyle" Class="mx-4 mb-4">
            <MudText Typo="Typo.caption" Color="Color.Secondary">Editing source</MudText>
            <MudText Typo="Typo.subtitle1" Style="font-weight: 600;">
                @EditingProvider!.DisplayName
            </MudText>
        </MudPaper>
    }

    @* ── Step indicator ─────────────────────────────────────────────────── *@
    <div class="px-4 mb-4">
        <MudStack Row="true" Spacing="2" AlignItems="AlignItems.Center"
                  Justify="Justify.Center">
            @for (int i = 0; i < _steps.Length; i++)
            {
                var step = i;
                <MudChip T="string"
                         Size="Size.Small"
                         Variant="@(step == _currentStep ? Variant.Filled : Variant.Outlined)"
                         Color="@(step == _currentStep ? Color.Primary : Color.Default)"
                         OnClick="@(() => _currentStep = step)">
                    @_steps[step]
                </MudChip>
            }
        </MudStack>
    </div>

    @* ── Step content ───────────────────────────────────────────────────── *@
    <div class="px-4" style="overflow-y: auto; flex: 1;">

        @switch (_currentStep)
        {
            @* ── Step 1: Basic Details ────────────────────────────────── *@
            case 0:
                <MudText Typo="Typo.subtitle2" Class="mb-3" Style="font-weight: 600;">
                    Basic Details
                </MudText>
                <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mb-4">
                    Give this source a name, enter its endpoint address, and provide
                    an API key if the service requires one.
                </MudText>

                <MudTextField @bind-Value="_sourceName"
                              Label="Source Name"
                              Placeholder="e.g. TMDB, MusicBrainz"
                              Variant="Variant.Outlined"
                              FullWidth="true"
                              Class="mb-3"
                              Margin="Margin.Dense" />

                <MudTextField @bind-Value="_endpointUrl"
                              Label="Endpoint URL"
                              Placeholder="https://api.example.com/v1"
                              Variant="Variant.Outlined"
                              FullWidth="true"
                              Class="mb-3"
                              Margin="Margin.Dense" />

                <MudTextField @bind-Value="_apiKey"
                              Label="API Key"
                              Placeholder="Leave blank for zero-key sources"
                              Variant="Variant.Outlined"
                              InputType="InputType.Password"
                              FullWidth="true"
                              Class="mb-4"
                              Margin="Margin.Dense" />

                <MudAlert Severity="Severity.Info" Dense="true" Class="mb-4">
                    Custom source registration requires Engine-side support. This wizard
                    collects the information needed — registration will be available in
                    a future Engine update.
                </MudAlert>
                break;

            @* ── Step 2: Advanced Mapping ─────────────────────────────── *@
            case 1:
                <MudText Typo="Typo.subtitle2" Class="mb-3" Style="font-weight: 600;">
                    Advanced Mapping
                </MudText>
                <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mb-4">
                    Schema mapping allows you to tell Tanaste how this source organises
                    its data — which fields map to title, author, cover art, and so on.
                </MudText>

                <MudPaper Elevation="0" Style="@InnerCardStyle" Class="mb-4">
                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2"
                              Class="mb-2">
                        <MudIcon Icon="@Icons.Material.Filled.Schema"
                                 Color="Color.Primary" Size="Size.Small" />
                        <MudText Typo="Typo.subtitle2" Style="font-weight: 600;">
                            Field Mapping
                        </MudText>
                    </MudStack>
                    <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mb-3">
                        Define how each response field from this source maps to a
                        Tanaste metadata key.
                    </MudText>
                    <MudAlert Severity="Severity.Info" Dense="true">
                        This feature is under development. Schema mapping will be available
                        when the Engine supports custom source registration.
                    </MudAlert>
                </MudPaper>

                <MudText Typo="Typo.caption" Color="Color.Secondary">
                    You can skip this step — it is entirely optional.
                </MudText>
                break;

            @* ── Step 3: Verify Connection ────────────────────────────── *@
            case 2:
                <MudText Typo="Typo.subtitle2" Class="mb-3" Style="font-weight: 600;">
                    Verify Connection
                </MudText>
                <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mb-4">
                    Test the connection to your source before saving. This sends a
                    lightweight probe request to the endpoint and confirms a valid
                    response.
                </MudText>

                @if (!string.IsNullOrWhiteSpace(_sourceName) ||
                     !string.IsNullOrWhiteSpace(_endpointUrl))
                {
                    <MudPaper Elevation="0" Style="@InnerCardStyle" Class="mb-4">
                        <MudText Typo="Typo.caption" Color="Color.Secondary" Class="mb-1">
                            Connection summary
                        </MudText>
                        <MudStack Spacing="1">
                            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                                <MudText Typo="Typo.caption" Color="Color.Secondary"
                                         Style="min-width: 70px;">
                                    Name:
                                </MudText>
                                <MudText Typo="Typo.body2" Style="font-weight: 600;">
                                    @(string.IsNullOrWhiteSpace(_sourceName) ? "—" : _sourceName)
                                </MudText>
                            </MudStack>
                            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                                <MudText Typo="Typo.caption" Color="Color.Secondary"
                                         Style="min-width: 70px;">
                                    Endpoint:
                                </MudText>
                                <MudText Typo="Typo.body2" Style="font-weight: 600; word-break: break-all;">
                                    @(string.IsNullOrWhiteSpace(_endpointUrl) ? "—" : _endpointUrl)
                                </MudText>
                            </MudStack>
                            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                                <MudText Typo="Typo.caption" Color="Color.Secondary"
                                         Style="min-width: 70px;">
                                    Auth:
                                </MudText>
                                <MudText Typo="Typo.body2" Style="font-weight: 600;">
                                    @(string.IsNullOrWhiteSpace(_apiKey) ? "Zero-key (no authentication)" : "API key provided")
                                </MudText>
                            </MudStack>
                        </MudStack>
                    </MudPaper>
                }

                <MudButton Variant="Variant.Outlined"
                           Color="Color.Primary"
                           FullWidth="true"
                           StartIcon="@Icons.Material.Filled.NetworkCheck"
                           OnClick="@RunConnectionTest"
                           Disabled="@_testing"
                           Class="mb-3">
                    @(_testing ? "Testing..." : "Run Connection Test")
                </MudButton>

                @if (_testResultShown)
                {
                    <MudAlert Severity="Severity.Info" Dense="true" Class="mb-4">
                        Connection testing is not yet available. This feature requires
                        Engine-side support for custom source registration.
                    </MudAlert>
                }
                break;
        }

    </div>

    @* ── Footer navigation ──────────────────────────────────────────────── *@
    <MudDivider Class="mt-auto" />
    <MudStack Row="true" Spacing="2" Class="pa-4" Justify="Justify.SpaceBetween">
        <MudButton Variant="Variant.Text"
                   Color="Color.Default"
                   OnClick="@PreviousStep"
                   Disabled="@(_currentStep == 0)">
            Back
        </MudButton>
        <MudSpacer />
        @if (_currentStep < _steps.Length - 1)
        {
            <MudButton Variant="Variant.Filled"
                       Color="Color.Primary"
                       OnClick="@NextStep">
                Next
            </MudButton>
        }
        else
        {
            <MudButton Variant="Variant.Filled"
                       Color="Color.Primary"
                       OnClick="@FinishWizard"
                       Disabled="@string.IsNullOrWhiteSpace(_sourceName)">
                Done
            </MudButton>
        }
    </MudStack>

</MudDrawer>

@code {

    private static readonly string[] _steps = ["Basic Details", "Advanced Mapping", "Verify Connection"];

    private const string DrawerStyle =
        "background: var(--tanaste-glass-bg); " +
        "border-left: 1px solid var(--tanaste-glass-border); " +
        "backdrop-filter: blur(20px); " +
        "-webkit-backdrop-filter: blur(20px); " +
        "display: flex; flex-direction: column;";

    private const string InnerCardStyle =
        "background: var(--tanaste-glass-inner-bg); " +
        "border: 1px solid var(--tanaste-glass-inner-border); " +
        "border-radius: 16px; " +
        "padding: 16px;";

    // ── Parameters ──────────────────────────────────────────────────────────────

    /// <summary>Whether the drawer is open. Two-way bound from parent.</summary>
    [Parameter] public bool Open { get; set; }
    [Parameter] public EventCallback<bool> OpenChanged { get; set; }

    /// <summary>
    /// When non-null, the wizard opens in "edit" mode for this provider.
    /// When null, it opens in "add" mode for a new source.
    /// </summary>
    [Parameter] public ProviderStatusDto? EditingProvider { get; set; }

    // ── State ────────────────────────────────────────────────────────────────────

    private int    _currentStep;
    private string _sourceName  = string.Empty;
    private string _endpointUrl = string.Empty;
    private string _apiKey      = string.Empty;
    private bool   _testing;
    private bool   _testResultShown;

    private bool IsEditing => EditingProvider is not null;

    // ── Lifecycle ────────────────────────────────────────────────────────────────

    protected override void OnParametersSet()
    {
        if (Open && IsEditing)
        {
            // Pre-fill fields from the provider being edited.
            _sourceName  = EditingProvider!.DisplayName;
            _endpointUrl = string.Empty; // Endpoint not exposed by current DTO.
            _apiKey      = string.Empty;
        }
    }

    // ── Navigation ──────────────────────────────────────────────────────────────

    private void NextStep()
    {
        if (_currentStep < _steps.Length - 1)
            _currentStep++;
    }

    private void PreviousStep()
    {
        if (_currentStep > 0)
            _currentStep--;
    }

    // ── Actions ─────────────────────────────────────────────────────────────────

    private async Task RunConnectionTest()
    {
        _testing = true;
        StateHasChanged();

        // Simulate a brief delay so the user sees the "Testing..." state.
        await Task.Delay(600);

        _testing         = false;
        _testResultShown = true;
    }

    private async Task FinishWizard()
    {
        // Stub: close the drawer. Real save requires Engine-side support.
        await CloseDrawer();
    }

    // ── Drawer open/close ───────────────────────────────────────────────────────

    private async Task CloseDrawer()
    {
        Open = false;
        await OpenChanged.InvokeAsync(false);
        ResetState();
    }

    private async Task OnOpenChangedHandler(bool open)
    {
        Open = open;
        await OpenChanged.InvokeAsync(open);
        if (!open) ResetState();
    }

    private void ResetState()
    {
        _currentStep     = 0;
        _sourceName      = string.Empty;
        _endpointUrl     = string.Empty;
        _apiKey          = string.Empty;
        _testing         = false;
        _testResultShown = false;
    }
}
