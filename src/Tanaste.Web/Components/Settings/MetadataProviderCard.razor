@namespace Tanaste.Web.Components.Settings

@* Single metadata provider card — extracted from the MetadataTab for reuse
   inside category-grouped MudExpansionPanels.

   Displays: drag handle (stub), status badge, provider name, domain/zero-key
   badges, capability icons, trust score bar, and enable/disable toggle.

   Write actions (toggle, edit, delete) are gated behind the IsAdmin parameter
   so Curators see a read-only view. *@

<MudPaper Elevation="0" Style="@InnerCardStyle" Class="mb-3">

    @* ── Row 1: Drag handle | Status badge | Name | Spacer | Edit | Delete ── *@
    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2" Class="mb-2">
        <MudTooltip Text="Reordering coming soon" Arrow="true" Placement="Placement.Right">
            <MudIcon Icon="@Icons.Material.Filled.DragIndicator"
                     Size="Size.Small"
                     Style="opacity: 0.30; cursor: default;" />
        </MudTooltip>

        <MudChip T="string" Size="Size.Small" Variant="Variant.Outlined"
                 Color="@StatusColor">
            @StatusLabel
        </MudChip>

        <MudText Typo="Typo.subtitle1" Style="flex: 1; min-width: 0; font-weight: 600;">
            @Provider.DisplayName
        </MudText>

        @if (IsAdmin)
        {
            <MudTooltip Text="Edit source" Arrow="true">
                <MudIconButton Icon="@Icons.Material.Outlined.Edit"
                               Size="Size.Small"
                               Color="Color.Default"
                               OnClick="@(() => OnEdit.InvokeAsync(Provider))" />
            </MudTooltip>
            <MudTooltip Text="Remove source" Arrow="true">
                <MudIconButton Icon="@Icons.Material.Outlined.Delete"
                               Size="Size.Small"
                               Color="Color.Error"
                               OnClick="@(() => OnDelete.InvokeAsync(Provider))" />
            </MudTooltip>
        }
    </MudStack>

    @* ── Row 2: Domain chip + Zero-key badge ── *@
    <MudStack Row="true" Spacing="1" AlignItems="AlignItems.Center" Class="mb-2"
              Style="flex-wrap: wrap;">
        @if (!string.IsNullOrEmpty(Provider.Domain))
        {
            <MudChip T="string" Size="Size.Small" Variant="Variant.Outlined"
                     Color="Color.Info">
                @Provider.Domain
            </MudChip>
        }
        @if (Provider.IsZeroKey)
        {
            <MudChip T="string" Size="Size.Small" Variant="Variant.Outlined"
                     Color="Color.Warning">
                Zero-key
            </MudChip>
        }
    </MudStack>

    @* ── Row 3: Capability icons ── *@
    @if (Provider.CapabilityTags is { Count: > 0 })
    {
        <MudStack Row="true" Spacing="1" AlignItems="AlignItems.Center"
                  Class="mb-2" Style="flex-wrap: wrap;">
            <MudText Typo="Typo.caption" Color="Color.Secondary" Class="mr-1">
                Provides:
            </MudText>
            @foreach (var tag in Provider.CapabilityTags)
            {
                @if (CapabilityIcons.TryGetValue(tag, out var icon))
                {
                    <MudTooltip Text="@tag" Arrow="true">
                        <MudIcon Icon="@icon" Size="Size.Small" Color="Color.Primary" />
                    </MudTooltip>
                }
                else
                {
                    <MudChip T="string" Size="Size.Small" Color="Color.Primary"
                             Variant="Variant.Text">
                        @tag
                    </MudChip>
                }
            }
        </MudStack>
    }

    @* ── Row 4: Trust score bar ── *@
    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2" Class="mb-2">
        <MudText Typo="Typo.caption" Color="Color.Secondary">Trust Score:</MudText>
        <MudProgressLinear Value="@(Provider.DefaultWeight * 100)"
                           Color="Color.Primary"
                           Size="Size.Small"
                           Style="flex: 1; max-width: 120px;" />
        <MudText Typo="Typo.caption" Style="font-weight: 600;">
            @((Provider.DefaultWeight * 100).ToString("F0"))%
        </MudText>
    </MudStack>

    @* ── Row 5: Per-field weights (collapsible) ── *@
    @if (Provider.FieldWeights is { Count: > 0 })
    {
        <MudExpansionPanels Elevation="0" Dense="true" Class="mb-2">
            <MudExpansionPanel Text="Field-specific trust"
                               Style="background: transparent; padding: 0;"
                               Dense="true">
                <MudStack Row="true" Spacing="1" Style="flex-wrap: wrap;">
                    @foreach (var fw in Provider.FieldWeights.OrderByDescending(kv => kv.Value))
                    {
                        <MudChip T="string" Size="Size.Small" Variant="Variant.Outlined">
                            @fw.Key: @((fw.Value * 100).ToString("F0"))%
                        </MudChip>
                    }
                </MudStack>
            </MudExpansionPanel>
        </MudExpansionPanels>
    }

    @* ── Row 6: Enable/disable toggle ── *@
    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
        <MudText Typo="Typo.caption" Color="Color.Secondary" Style="flex: 1;">
            @(Provider.Enabled ? "This source is active and contributing to your library." : "This source is currently disabled.")
        </MudText>
        <MudSwitch T="bool"
                   Value="@Provider.Enabled"
                   ValueChanged="@(v => OnToggle.InvokeAsync((Provider.Name, v)))"
                   Color="Color.Primary"
                   Disabled="@(IsToggling || !IsAdmin)" />
    </MudStack>

</MudPaper>

@code {
    [Parameter, EditorRequired]
    public ProviderStatusDto Provider { get; set; } = default!;

    [Parameter] public bool IsToggling { get; set; }

    /// <summary>
    /// When true, the user has Administrator access — edit, delete, and toggle
    /// controls are interactive. When false, the card is read-only.
    /// </summary>
    [Parameter] public bool IsAdmin { get; set; }

    [Parameter] public EventCallback<(string Name, bool Enabled)> OnToggle { get; set; }
    [Parameter] public EventCallback<ProviderStatusDto> OnEdit   { get; set; }
    [Parameter] public EventCallback<ProviderStatusDto> OnDelete { get; set; }

    // ── Status badge ────────────────────────────────────────────────────────────

    private string StatusLabel => Provider.Enabled
        ? (Provider.IsReachable ? "Reachable" : "Unreachable")
        : "Disabled";

    private Color StatusColor => Provider.Enabled
        ? (Provider.IsReachable ? Color.Success : Color.Error)
        : Color.Default;

    // ── Capability icon mapping ─────────────────────────────────────────────────

    private static readonly Dictionary<string, string> CapabilityIcons =
        new(StringComparer.OrdinalIgnoreCase)
        {
            ["cover"]           = Icons.Material.Filled.Image,
            ["narrator"]        = Icons.Material.Filled.RecordVoiceOver,
            ["series"]          = Icons.Material.Filled.PlaylistPlay,
            ["series_position"] = Icons.Material.Filled.FormatListNumbered,
            ["description"]     = Icons.Material.Filled.Description,
            ["title"]           = Icons.Material.Filled.Title,
            ["author"]          = Icons.Material.Filled.Person,
            ["rating"]          = Icons.Material.Filled.Star,
            ["biography"]       = Icons.Material.Filled.MenuBook,
            ["headshot"]        = Icons.Material.Filled.Face,
            ["franchise"]       = Icons.Material.Filled.AccountTree,
            ["person_id"]       = Icons.Material.Filled.Badge,
        };

    // ── Style constants ─────────────────────────────────────────────────────────

    private const string InnerCardStyle =
        "background: var(--tanaste-glass-inner-bg); " +
        "border: 1px solid var(--tanaste-glass-inner-border); " +
        "border-radius: 16px; " +
        "padding: 20px;";
}
