@namespace Tanaste.Web.Components.Settings
@inject UIOrchestratorService Orchestrator
@implements IDisposable

@* Activity timeline — plain-English summary of recent library events. *@

<MudPaper Elevation="0" Style="@GlassStyle">

    <MudStack Row="true" AlignItems="AlignItems.Center" Class="mb-2">
        <MudIcon Icon="@Icons.Material.Outlined.Timeline" Color="Color.Primary" Class="mr-2" />
        <MudText Typo="Typo.h6">Recent Activity</MudText>
        <MudSpacer />
        <MudChip T="string" Size="Size.Small" Variant="Variant.Outlined"
                 Color="@(Orchestrator.IsIntercomConnected ? Color.Success : Color.Warning)">
            @(Orchestrator.IsIntercomConnected ? "Live" : "Offline")
        </MudChip>
    </MudStack>
    <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mb-4">
        A live feed of what is happening in your library. Events appear here as the
        Engine processes files, enriches metadata, and connects to providers.
    </MudText>

    @if (_entries.Count == 0)
    {
        <MudAlert Severity="Severity.Info" Class="mt-2">
            No activity yet. Events will appear here as the Engine processes files,
            enriches metadata, and responds to changes.
        </MudAlert>
    }
    else
    {
        <MudTimeline TimelinePosition="TimelinePosition.Start">
            @foreach (var entry in _entries)
            {
                <MudTimelineItem Color="@KindColor(entry.Kind)" Size="Size.Small">
                    <ItemDot>
                        <MudIcon Icon="@MaterialIcon(entry.Icon)" Size="Size.Small" />
                    </ItemDot>
                    <ItemContent>
                        <MudStack Spacing="0" Class="mb-3">
                            <MudText Typo="Typo.body2" Style="font-weight: 600;">
                                @entry.Summary
                            </MudText>
                            @if (!string.IsNullOrEmpty(entry.Detail))
                            {
                                <MudText Typo="Typo.caption" Color="Color.Secondary">
                                    @entry.Detail
                                </MudText>
                            }
                            <MudText Typo="Typo.caption" Style="color: var(--tanaste-text-faint);">
                                @FormatTime(entry.OccurredAt)
                            </MudText>
                        </MudStack>
                    </ItemContent>
                </MudTimelineItem>
            }
        </MudTimeline>
    }

</MudPaper>

@code {

    private const string GlassStyle =
        "background: var(--tanaste-glass-bg); " +
        "border: 1px solid var(--tanaste-glass-border); " +
        "backdrop-filter: blur(10px); " +
        "-webkit-backdrop-filter: blur(10px); " +
        "border-radius: 24px; " +
        "padding: 32px;";

    private IReadOnlyList<ActivityEntry> _entries = [];

    // ── Lifecycle ────────────────────────────────────────────────────────────────

    protected override void OnInitialized()
    {
        _entries = Orchestrator.GetActivityLog();
        Orchestrator.OnActivityChanged += OnActivityChanged;
    }

    public void Dispose()
    {
        Orchestrator.OnActivityChanged -= OnActivityChanged;
    }

    private void OnActivityChanged()
    {
        _entries = Orchestrator.GetActivityLog();
        InvokeAsync(StateHasChanged);
    }

    // ── Helpers ──────────────────────────────────────────────────────────────────

    private static Color KindColor(ActivityKind kind) => kind switch
    {
        ActivityKind.MediaAdded         => Color.Success,
        ActivityKind.MetadataUpdated    => Color.Info,
        ActivityKind.PersonEnriched     => Color.Info,
        ActivityKind.IngestionProgress  => Color.Primary,
        ActivityKind.ServerStatus       => Color.Default,
        ActivityKind.WatchFolderChanged => Color.Warning,
        ActivityKind.Error              => Color.Error,
        _                               => Color.Default,
    };

    private static string MaterialIcon(string iconName) => iconName switch
    {
        "library_add"          => Icons.Material.Filled.LibraryAdd,
        "person"               => Icons.Material.Filled.Person,
        "sync"                 => Icons.Material.Filled.Sync,
        "folder_open"          => Icons.Material.Filled.FolderOpen,
        "power_settings_new"   => Icons.Material.Filled.PowerSettingsNew,
        "error"                => Icons.Material.Filled.Error,
        "auto_awesome"         => Icons.Material.Filled.AutoAwesome,
        _                      => Icons.Material.Filled.Circle,
    };

    private static string FormatTime(DateTimeOffset dt)
    {
        var local = dt.LocalDateTime;
        var diff  = DateTimeOffset.Now - dt;

        if (diff.TotalSeconds < 60)  return "Just now";
        if (diff.TotalMinutes < 60)  return $"{(int)diff.TotalMinutes}m ago";
        if (diff.TotalHours   < 24)  return $"{(int)diff.TotalHours}h ago";
        return local.ToString("MMM d, HH:mm");
    }
}
